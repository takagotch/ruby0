/***
 * Excerpted from "CoffeeScript: Accelerated JavaScript Development, Second Edition",
 * published by The Pragmatic Bookshelf.
 * Copyrights apply to this code. It may not be used to create training material, 
 * courses, books, articles, and the like. Contact us if you are in doubt.
 * We make no guarantees that this code is fit for any purpose. 
 * Visit http://www.pragmaticprogrammer.com/titles/tbcoffee2 for more book information.
***/
'use strict';

var setPrototypeOf = require('es5-ext/object/set-prototype-of')
  , d              = require('d')
  , Iterator       = require('../')
  , validIterable  = require('../valid-iterable')

  , push = Array.prototype.push
  , defineProperties = Object.defineProperties
  , IteratorChain;

IteratorChain = function (iterators) {
	defineProperties(this, {
		__iterators__: d('', iterators),
		__current__: d('w', iterators.shift())
	});
};
if (setPrototypeOf) setPrototypeOf(IteratorChain, Iterator);

IteratorChain.prototype = Object.create(Iterator.prototype, {
	constructor: d(IteratorChain),
	next: d(function () {
		var result;
		if (!this.__current__) return { done: true, value: undefined };
		result = this.__current__.next();
		while (result.done) {
			this.__current__ = this.__iterators__.shift();
			if (!this.__current__) return { done: true, value: undefined };
			result = this.__current__.next();
		}
		return result;
	})
});

module.exports = function () {
	var iterators = [this];
	push.apply(iterators, arguments);
	iterators.forEach(validIterable);
	return new IteratorChain(iterators);
};
