/***
 * Excerpted from "CoffeeScript: Accelerated JavaScript Development, Second Edition",
 * published by The Pragmatic Bookshelf.
 * Copyrights apply to this code. It may not be used to create training material, 
 * courses, books, articles, and the like. Contact us if you are in doubt.
 * We make no guarantees that this code is fit for any purpose. 
 * Visit http://www.pragmaticprogrammer.com/titles/tbcoffee2 for more book information.
***/
'use strict';

var isPlainObject = require('./is-plain-object')
  , value         = require('./valid-value')

  , keys = Object.keys
  , copy;

copy = function (source) {
	var target = {};
	this[0].push(source);
	this[1].push(target);
	keys(source).forEach(function (key) {
		var index;
		if (!isPlainObject(source[key])) {
			target[key] = source[key];
			return;
		}
		index = this[0].indexOf(source[key]);
		if (index === -1) target[key] = copy.call(this, source[key]);
		else target[key] = this[1][index];
	}, this);
	return target;
};

module.exports = function (source) {
	var obj = Object(value(source));
	if (obj !== source) return obj;
	return copy.call([[], []], obj);
};
