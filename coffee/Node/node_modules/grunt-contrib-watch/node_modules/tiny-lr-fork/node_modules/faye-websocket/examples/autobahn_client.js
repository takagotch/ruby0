/***
 * Excerpted from "CoffeeScript: Accelerated JavaScript Development, Second Edition",
 * published by The Pragmatic Bookshelf.
 * Copyrights apply to this code. It may not be used to create training material, 
 * courses, books, articles, and the like. Contact us if you are in doubt.
 * We make no guarantees that this code is fit for any purpose. 
 * Visit http://www.pragmaticprogrammer.com/titles/tbcoffee2 for more book information.
***/
var WebSocket = require('../lib/faye/websocket'),
    pace      = require('pace');

var host  = 'ws://localhost:9001',
    agent = 'Node ' + process.version,
    cases = 0,
    skip  = [];

var socket = new WebSocket.Client(host + '/getCaseCount'),
    progress;

socket.onmessage = function(event) {
  console.log('Total cases to run: ' + event.data);
  cases = parseInt(event.data);
  progress = pace(cases);
};

socket.onclose = function() {
  var runCase = function(n) {
    progress.op();

    if (n > cases) {
      socket = new WebSocket.Client(host + '/updateReports?agent=' + encodeURIComponent(agent));
      socket.onclose = process.exit;

    } else if (skip.indexOf(n) >= 0) {
      runCase(n + 1);

    } else {
      socket = new WebSocket.Client(host + '/runCase?case=' + n + '&agent=' + encodeURIComponent(agent));

      socket.onmessage = function(event) {
        socket.send(event.data);
      };

      socket.onclose = function() {
        runCase(n + 1);
      };
    }
  };

  runCase(1);
};

